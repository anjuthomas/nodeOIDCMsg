var jws = require('jws');
var once = require('lodash.once');
var message = require('message');

module.exports = function (tokenProfile, secretOrPrivateKey, options, callback) {

  var messageInfo = message.sign(tokenProfile, secretOrPrivateKey, options, callback);
  var header = messageInfo["header"];
  var payload = messageInfo["payload"];
  var options = messageInfo["options"]

  var encoding = options.encoding || 'utf8';

  if (typeof callback === 'function') {
    callback = callback && once(callback);

    jws.createSign({
      header: header,
      privateKey: secretOrPrivateKey,
      payload: payload,
      encoding: encoding
    }).once('error', callback)
      .once('done', function (signature) {
        callback(null, signature);
      });
  } else {
    return jws.sign({header: header, payload: payload, secret: secretOrPrivateKey, encoding: encoding});
  }
};
